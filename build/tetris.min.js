window.onload=function(){var a=10,b=14,c=Date.now(),d=1100,e=50,f=0,g=!1,h=!1,i=0,j=0,k=1,l=1,m=[],n=function(a,b){this.y=a,this.x=b},o={x:0,y:0,color:"",coordinates:[]},p={square:[new n(0,0),new n(0,1),new n(1,0),new n(1,1)],rightL:[new n(1,0),new n(1,1),new n(1,2),new n(0,2)],rightS:[new n(0,0),new n(0,1),new n(1,1),new n(1,2)],leftL:[new n(0,0),new n(1,0),new n(1,1),new n(1,2)],leftS:[new n(1,0),new n(1,1),new n(0,1),new n(0,2)],line:[new n(0,0),new n(0,1),new n(0,2),new n(0,3)]},q=1,r="*",s=function(){m=[];for(var a=0;b>a;a++)m.push(t())},t=function(b){for(var c=[],d=b?b:0,e=0;a>e;e++)c.push(d);return c},u=function(){document.onkeydown=function(a){if(a=a||window.event,g)return void Q(!1);switch(a.keyCode){case 37:K();break;case 38:I();break;case 39:L();break;case 40:M();break;case 32:N();break;default:Q(!0)}}},v=function(){return m[0].contains(q)};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0};var w=function(a){return!a.contains(0)},x=function(){return m.reduce(function(a,b){return a+(w(b)?1:0)},0)},y=function(){for(var a=[],b=[],c=m.length-1;c>=0;c--){var d=m[c];w(d)?a.push(t()):b.unshift(d)}m=a.concat(b),S.renderMatrix()},z=function(){var a=[0,40,100,300,1200],b=x();i+=a[b]*A(),j+=b,console.log("score: "+i)},A=function(){return Math.floor(j/l)+1},B=function(){var a=A();a>k&&(k=a,d-=e,console.log("  level: "+k),console.log("timeout: "+d))},C=function(){o.y=0;var b=Object.keys(p);o.coordinates=p[b[Math.floor(Math.random()*b.length)]];var c=o.coordinates.reduce(function(a,b){return Math.max(a,b.x)},0);o.x=Math.floor((a-c)/2),F()},D=function(a){if("clear"===a){var b=0;S.clearPiece()}else{var b=r;S.drawPiece("#ffffff")}for(var b="clear"===a?0:r,c=0;c<o.coordinates.length;c++){var d=o.coordinates[c];try{m[o.y+d.y][o.x+d.x]=b}catch(e){console.log(a),console.log("piece.y + coordinate.y: "+(o.y+d.y)),console.log("piece.x + coordinate.x: "+(o.x+d.x)),console.log(JSON.stringify(o))}}},E=function(){D("clear")},F=function(){D("draw")},G=function(){for(var a=0;a<o.coordinates.length;a++)m[o.coordinates[a].y+o.y][o.coordinates[a].x+o.x]=q},H=function(){for(var a=[],b=0;b<o.coordinates.length;b++){var c=o.coordinates[b];a.push(new n(c.y,c.x))}return a},I=function(){var a=H();a=a.map(function(a){return new n(0-a.x,a.y)});var b=o.coordinates.reduce(function(a,b){return new n(null,Math.max(a.x,b.x))},o.coordinates[0]).x;a=a.map(function(a){return new n(a.y+b,a.x)}),a.every(function(a){return!P(a.y+o.y,a.x+o.x)})&&(E(),o.coordinates=a,F())},J=function(){E(),o.y++,F()},K=function(){O("left")||(E(),o.x--,F())},L=function(){O("right")||(E(),o.x++,F())},M=function(){O("bottom")||(E(),o.y++,F())},N=function(){for(;!O("bottom");)E(),o.y++,F()},O=function(a){if("right"===a)var b=function(a){return new n(a.y,a.x+1)};else"left"===a?b=function(a){return new n(a.y,a.x-1)}:"bottom"===a&&(b=function(a){return new n(a.y+1,a.x)});for(var c=o.coordinates.map(b),d=0;d<c.length;d++){var e=c[d].x+o.x,f=c[d].y+o.y;if(P(f,e))return!0}return!1},P=function(b,c){return console.log(b),0>c||c>=a||b>=m.length||m[b][c]===q},Q=function(a){g=a},R=function(){var c=30,d=document.getElementById("canvas");d.width=c*a,d.height=c*b,window.context=d.getContext("2d");var e="#000000",f="rebeccapurple",g=function(){return f};this.initializeCanvas=function(){window.context.fillStyle=e,window.context.fillRect(0,0,d.width,d.height)},this.drawPiece=function(a){"clear"===a?window.context.fillStyle=e:window.context.fillStyle=g();for(var b=0;b<o.coordinates.length;b++){var d=(o.x+o.coordinates[b].x)*c,f=(o.y+o.coordinates[b].y)*c;window.context.fillRect(d,f,c,c)}},this.clearPiece=function(){this.drawPiece("clear")},this.renderMatrix=function(){for(var d=0;b>d;d++)for(var f=0;a>f;f++){switch(m[d][f]){case q:window.context.fillStyle=g();break;default:window.context.fillStyle=e}window.context.fillRect(f*c,d*c,c,c)}}},S=new R,T=function(){window.setTimeout(function(){if(!g){if(h)return;if(c=Date.now(),O("bottom")&&0!==f){if(G(),z(),B(),y(),v())return void(h=!0);C()}else J();f++}T()},d)};window.game=T;var U=function(){S.initializeCanvas(),s(),u(),C(),T()};U()};