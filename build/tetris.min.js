window.onload=function(){var a=10,b=14,c=Date.now(),d=1e3,e=50,f=0,g=!1,h=!1,i=0,j=0,k=1,l=1,m=[],n=function(a,b){this.y=a,this.x=b},o={x:0,y:0,color:"",coordinates:[]},p={square:[new n(0,0),new n(0,1),new n(1,0),new n(1,1)],rightL:[new n(1,0),new n(1,1),new n(1,2),new n(0,2)],rightS:[new n(0,0),new n(0,1),new n(1,1),new n(1,2)],leftL:[new n(0,0),new n(1,0),new n(1,1),new n(1,2)],leftS:[new n(1,0),new n(1,1),new n(0,1),new n(0,2)],line:[new n(0,0),new n(0,1),new n(0,2),new n(0,3)]},q=1,r="*",s=function(){m=[];for(var a=0;b>a;a++)m.push(t())},t=function(b){for(var c=[],d=b?b:0,e=0;a>e;e++)c.push(d);return c},u=function(){document.onkeydown=function(a){if(a=a||window.event,g)return void Q(!1);switch(a.keyCode){case 37:L();break;case 38:J();break;case 39:M();break;case 40:K();break;case 32:N();break;default:Q(!0)}}},v=function(){return m[0].contains(q)},w=function(a){return!a.contains(0)},x=function(){return m.reduce(function(a,b){return a+(w(b)?1:0)},0)},y=function(){for(var a=[],b=[],c=m.length-1;c>=0;c--){var d=m[c];w(d)?a.push(t()):b.unshift(d)}m=a.concat(b),S.renderMatrix()},z=function(){var a=[0,40,100,300,1200],b=x();i+=a[b]*A(),j+=b,console.log("score: "+i)},A=function(){return Math.floor(j/l)+1},B=function(){return d>e?d-(k-1)*e:e},C=function(){var a=A();a>k&&(k=a,console.log("  level: "+k),console.log("timeout: "+B()))},D=function(){o.y=0;var b=Object.keys(p);o.coordinates=p[b[Math.floor(Math.random()*b.length)]];var c=o.coordinates.reduce(function(a,b){return Math.max(a,b.x)},0);o.x=Math.floor((a-c)/2),G()},E=function(a){if("clear"===a){var b=0;S.clearPiece()}else{var b=r;S.drawPiece("#ffffff")}for(var b="clear"===a?0:r,c=0;c<o.coordinates.length;c++){var d=o.coordinates[c];m[o.y+d.y][o.x+d.x]=b}},F=function(){E("clear")},G=function(){E("draw")},H=function(){for(var a=0;a<o.coordinates.length;a++)m[o.coordinates[a].y+o.y][o.coordinates[a].x+o.x]=q},I=function(){for(var a=[],b=0;b<o.coordinates.length;b++){var c=o.coordinates[b];a.push(new n(c.y,c.x))}return a},J=function(){var a=I();a=a.map(function(a){return new n(0-a.x,a.y)});var b=o.coordinates.reduce(function(a,b){return a.x>b.x?a:b},o.coordinates[0]).x;a=a.map(function(a){return new n(a.y+b,a.x)}),a.every(function(a){return!P(a.y+o.y,a.x+o.x)})&&(F(),o.coordinates=a,G())},K=function(){O("bottom")||(F(),o.y++,G())},L=function(){O("left")||(F(),o.x--,G())},M=function(){O("right")||(F(),o.x++,G())},N=function(){for(;!O("bottom");)F(),o.y++,G()},O=function(a){if("right"===a)var b=function(a){return new n(a.y,a.x+1)};else"left"===a?b=function(a){return new n(a.y,a.x-1)}:"bottom"===a&&(b=function(a){return new n(a.y+1,a.x)});var c=o.coordinates.map(b);return c.some(function(a){var b=a.x+o.x,c=a.y+o.y;return P(c,b)})},P=function(c,d){return 0>d||d>=a||c>=b||m[c][d]===q},Q=function(a){g=a},R=function(){var c=30,d=document.getElementById("canvas");d.width=c*a,d.height=c*b,window.context=d.getContext("2d");var e="#000000",f="rebeccapurple",g=function(){return f};this.initializeCanvas=function(){window.context.fillStyle=e,window.context.fillRect(0,0,d.width,d.height)},this.drawPiece=function(a){"clear"===a?window.context.fillStyle=e:window.context.fillStyle=g();for(var b=0;b<o.coordinates.length;b++){var d=(o.x+o.coordinates[b].x)*c,f=(o.y+o.coordinates[b].y)*c;window.context.fillRect(d,f,c,c)}},this.clearPiece=function(){this.drawPiece("clear")},this.renderMatrix=function(){for(var d=0;b>d;d++)for(var f=0;a>f;f++){switch(m[d][f]){case q:window.context.fillStyle=g();break;default:window.context.fillStyle=e}window.context.fillRect(f*c,d*c,c,c)}}},S=new R,T=function(){window.setTimeout(function(){if(!g){if(h)return void V();if(c=Date.now(),O("bottom")&&0!==f){if(H(),z(),C(),y(),v())return h=!0,void console.log("game over");D()}else K();f++}T()},B())};window.game=T;var U=function(){S.initializeCanvas(),s(),u(),D(),T()};U();var V=function(){_(i)||aa(i)},W=5,X=function(){return JSON.parse(localStorage.highScores)||[0]},Y=function(a){var b=X();b.push(a),b.sortNumbers().reverse(),b=b.slice(0,W),localStorage.highScores=JSON.stringify(b)},Z=function(a){return a>X()[0]},$=function(a){return a>X().last()},_=function(a){return Z()?(Y(a),!0):void 0},aa=function(a){return $()?(Y(a),!0):void 0};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0},Array.prototype.sortNumbers=function(a){return this.sort(function(a,b){return a-b})}};