window.onload=function(){var a=10,b=14,c=2,d=Date.now(),e=1e3,f=50,g=0,h=!1,i=!1,j=0,k=0,l=1,m=1,n=[],o=function(a,b){this.y=a,this.x=b},p={x:0,y:0,color:"",coordinates:[]},q={square:[new o(0,0),new o(0,1),new o(1,0),new o(1,1)],rightL:[new o(1,0),new o(1,1),new o(1,2),new o(0,2)],rightS:[new o(0,0),new o(0,1),new o(1,1),new o(1,2)],leftL:[new o(0,0),new o(1,0),new o(1,1),new o(1,2)],leftS:[new o(1,0),new o(1,1),new o(0,1),new o(0,2)],line:[new o(0,0),new o(0,1),new o(0,2),new o(0,3)]},r=1,s="*",t=function(){window.Game={boardWidth:a,boardHeight:b,maxPieceHeight:c,time:d,timeout:e,timeoutIncrement:f,steps:g,paused:h,gameOver:i,score:j,lines:k,level:l,numberOfLinesBeforeNextLevel:m,matrix:n}},u=function(){n=[];for(var a=0;b>a;a++)n.push(v())},v=function(b){for(var c=[],d=b?b:0,e=0;a>e;e++)c.push(d);return c},w=function(){document.onkeydown=function(a){if(a=a||window.event,h)return void S(!1);switch(a.keyCode){case 37:N();break;case 38:L();break;case 39:O();break;case 40:M();break;case 32:P();break;default:S(!0)}}},x=function(){return n[0].contains(r)},y=function(a){return!a.contains(0)},z=function(){return n.reduce(function(a,b){return a+(y(b)?1:0)},0)},A=function(){for(var a=[],b=[],c=n.length-1;c>=0;c--){var d=n[c];y(d)?a.push(v()):b.unshift(d)}n=a.concat(b),U.renderMatrix()},B=function(){var a=[0,40,100,300,1200],b=z();j+=a[b]*C(),k+=b,console.log("score: "+j)},C=function(){return Math.floor(k/m)+1},D=function(){return e>f?e-(l-1)*f:f},E=function(){var a=C();a>l&&(l=a,console.log("  level: "+l),console.log("timeout: "+D()))},F=function(){p.y=0;var b=Object.keys(q);p.coordinates=q[b[Math.floor(Math.random()*b.length)]];var c=p.coordinates.reduce(function(a,b){return Math.max(a,b.x)},0);p.x=Math.floor((a-c)/2),I()},G=function(a){if("clear"===a){var b=0;U.clearPiece()}else{var b=s;U.drawPiece("#ffffff")}for(var b="clear"===a?0:s,c=0;c<p.coordinates.length;c++){var d=p.coordinates[c];n[p.y+d.y][p.x+d.x]=b}},H=function(){G("clear")},I=function(){G("draw")},J=function(){for(var a=0;a<p.coordinates.length;a++)n[p.coordinates[a].y+p.y][p.coordinates[a].x+p.x]=r},K=function(){for(var a=[],b=0;b<p.coordinates.length;b++){var c=p.coordinates[b];a.push(new o(c.y,c.x))}return a},L=function(){var a=K();a=a.map(function(a){return new o(0-a.x,a.y)});var b=p.coordinates.reduce(function(a,b){return a.x>b.x?a:b},p.coordinates[0]).x;a=a.map(function(a){return new o(a.y+b,a.x)}),a.every(function(a){return!R(a.y+p.y,a.x+p.x)})&&(H(),p.coordinates=a,I())},M=function(){Q("bottom")||(H(),p.y++,I())},N=function(){Q("left")||(H(),p.x--,I())},O=function(){Q("right")||(H(),p.x++,I())},P=function(){for(;!Q("bottom");)H(),p.y++,I()},Q=function(a){if("right"===a)var b=function(a){return new o(a.y,a.x+1)};else"left"===a?b=function(a){return new o(a.y,a.x-1)}:"bottom"===a&&(b=function(a){return new o(a.y+1,a.x)});var c=p.coordinates.map(b);return c.some(function(a){var b=a.x+p.x,c=a.y+p.y;return R(c,b)})},R=function(c,d){return 0>d||d>=a||c>=b||n[c][d]===r},S=function(a){h=a},T=function(){var c=30,d=document.getElementById("canvas");d.width=c*a,d.height=c*b,window.context=d.getContext("2d");var e="#000000",f="rebeccapurple",g=function(){return f};this.initializeCanvas=function(){window.context.fillStyle=e,window.context.fillRect(0,0,d.width,d.height)},this.drawPiece=function(a){"clear"===a?window.context.fillStyle=e:window.context.fillStyle=g();for(var b=0;b<p.coordinates.length;b++){var d=(p.x+p.coordinates[b].x)*c,f=(p.y+p.coordinates[b].y)*c;window.context.fillRect(d,f,c,c)}},this.clearPiece=function(){this.drawPiece("clear")},this.renderMatrix=function(){for(var d=0;b>d;d++)for(var f=0;a>f;f++){switch(n[d][f]){case r:window.context.fillStyle=g();break;default:window.context.fillStyle=e}window.context.fillRect(f*c,d*c,c,c)}}},U=new T,V=function(){window.setTimeout(function(){if(!h){if(i)return;if(d=Date.now(),Q("bottom")&&0!==g){if(J(),B(),E(),A(),x())return i=!0,X(),t(),void console.log("game over");F()}else M();g++}V()},D())};window.game=V;var W=function(){U.initializeCanvas(),u(),w(),F(),V()};W();var X=function(){console.trace(),ba(j)?console.log("new high score"):ca(j)&&console.log("new top five score")},Y=5,Z=function(){return console.log("getHighScores: "+j),JSON.parse(localStorage.highScores||"[]")},$=function(a){console.log("addScoreToHighScores: "+a);var b=Z();b.push(a),b.sortNumbers().reverse(),b=b.slice(0,Y),localStorage.highScores=JSON.stringify(b)},_=function(a){return console.log("scoreIsNewHighScore: "+a),a>(Z()[0]||0)},aa=function(a){console.log("scoreIsInTopRange: "+a);var b=Z();return a>(b.last()||0)||b.length<Y},ba=function(a){return console.log("storeNewHighScore: "+a),_(a)&&0!=a?($(a),!0):void 0},ca=function(a){return console.log("storeNewTopScore: "+a),aa(a)&&0!=a?($(a),!0):void 0};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0},Array.prototype.sortNumbers=function(a){return this.sort(function(a,b){return a-b})}};