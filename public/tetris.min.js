window.onload=function(){var a={},b=function(a,b){this.y=a,this.x=b},c={x:0,y:0,color:"",coordinates:[]},d={square:[new b(0,0),new b(0,1),new b(1,0),new b(1,1)],rightL:[new b(1,0),new b(1,1),new b(1,2),new b(0,2)],rightS:[new b(0,0),new b(0,1),new b(1,1),new b(1,2)],leftL:[new b(0,0),new b(1,0),new b(1,1),new b(1,2)],leftS:[new b(1,0),new b(1,1),new b(0,1),new b(0,2)],line:[new b(0,0),new b(0,1),new b(0,2),new b(0,3)],three:[new b(0,0),new b(0,1),new b(0,2),new b(1,1)]},e=1,f="*",g=function(){window.DataDump={boardWidth:a.boardWidth,boardHeight:a.boardHeight,time:a.time,timeout:a.timeout,timeoutIncrement:a.timeoutIncrement,steps:a.steps,paused:a.paused,gameOver:a.gameOver,score:a.score,lines:a.lines,level:a.level,numberOfLinesBeforeNextLevel:a.numberOfLinesBeforeNextLevel,matrix:a.matrix}},h=function(){a={boardWidth:10,boardHeight:14,time:Date.now(),timeout:1e3,timeoutIncrement:50,steps:0,paused:!1,gameOver:!1,score:0,lines:0,level:1,numberOfLinesBeforeNextLevel:10,matrix:[]}};h();var i=function(){a.matrix=[];for(var b=0;b<a.boardHeight;b++)a.matrix.push(j())},j=function(b){for(var c=[],d=b?b:0,e=0;e<a.boardWidth;e++)c.push(d);return c},k=function(){document.onkeydown=function(b){if(b=b||window.event,a.paused)return void G(!1);switch(b.keyCode){case 37:B();break;case 38:z();break;case 39:C();break;case 40:A();break;case 32:D();break;default:G(!0)}}},l=function(){return a.matrix[0].contains(e)},m=function(a){return!a.contains(0)},n=function(){return a.matrix.reduce(function(a,b){return a+(m(b)?1:0)},0)},o=function(){for(var b=[],c=[],d=a.matrix.length-1;d>=0;d--){var e=a.matrix[d];m(e)?b.push(j()):c.unshift(e)}a.matrix=b.concat(c),I.renderMatrix()},p=function(){var b=[0,40,100,300,1200],c=n();a.score+=b[c]*q(),a.lines+=c,console.log("score: "+a.score)},q=function(){return Math.floor(a.lines/a.numberOfLinesBeforeNextLevel)+1},r=function(){return a.timeout>a.timeoutIncrement?a.timeout-(a.level-1)*a.timeoutIncrement:a.timeoutIncrement},s=function(){var b=q();b>a.level&&(a.level=b,console.log("  Game.level: "+a.level),console.log("Game.timeout: "+r()))},t=function(){c.y=0;var b=Object.keys(d);c.coordinates=d[b[Math.floor(Math.random()*b.length)]];var e=c.coordinates.reduce(function(a,b){return Math.max(a,b.x)},0);c.x=Math.floor((a.boardWidth-e)/2),w()},u=function(b){if("clear"===b){var d=0;I.clearPiece()}else{var d=f;I.drawPiece("#ffffff")}for(var d="clear"===b?0:f,e=0;e<c.coordinates.length;e++){var g=c.coordinates[e];a.matrix[c.y+g.y][c.x+g.x]=d}},v=function(){u("clear")},w=function(){u("draw")},x=function(){for(var b=0;b<c.coordinates.length;b++)a.matrix[c.coordinates[b].y+c.y][c.coordinates[b].x+c.x]=e},y=function(){for(var a=[],d=0;d<c.coordinates.length;d++){var e=c.coordinates[d];a.push(new b(e.y,e.x))}return a},z=function(){var a=y();a=a.map(function(a){return new b(0-a.x,a.y)});var d=c.coordinates.reduce(function(a,b){return a.x>b.x?a:b},c.coordinates[0]).x;a=a.map(function(a){return new b(a.y+d,a.x)}),a.every(function(a){return!F(a.y+c.y,a.x+c.x)})&&(v(),c.coordinates=a,w())},A=function(){E("bottom")||(v(),c.y++,w())},B=function(){E("left")||(v(),c.x--,w())},C=function(){E("right")||(v(),c.x++,w())},D=function(){for(;!E("bottom");)v(),c.y++,w()},E=function(a){if("right"===a)var d=function(a){return new b(a.y,a.x+1)};else"left"===a?d=function(a){return new b(a.y,a.x-1)}:"bottom"===a&&(d=function(a){return new b(a.y+1,a.x)});var e=c.coordinates.map(d);return e.some(function(a){var b=a.x+c.x,d=a.y+c.y;return F(d,b)})},F=function(b,c){return 0>c||c>=a.boardWidth||b>=a.boardHeight||a.matrix[b][c]===e},G=function(b){a.paused=b},H=function(){var b=30,d=document.getElementById("tetris");d.width=b*a.boardWidth,d.height=b*a.boardHeight,window.context=d.getContext("2d");var f="#000000",g="rebeccapurple",h=function(){return g};this.initializeCanvas=function(){window.context.fillStyle=f,window.context.fillRect(0,0,d.width,d.height)},this.drawPiece=function(a){"clear"===a?window.context.fillStyle=f:window.context.fillStyle=h();for(var d=0;d<c.coordinates.length;d++){var e=(c.x+c.coordinates[d].x)*b,g=(c.y+c.coordinates[d].y)*b;window.context.fillRect(e,g,b,b)}},this.clearPiece=function(){this.drawPiece("clear")},this.renderMatrix=function(){for(var c=0;c<a.boardHeight;c++)for(var d=0;d<a.boardWidth;d++){switch(a.matrix[c][d]){case e:window.context.fillStyle=h();break;default:window.context.fillStyle=f}window.context.fillRect(d*b,c*b,b,b)}}},I=new H,J=function(){window.setTimeout(function(){if(!a.paused){if(a.gameOver)return;if(a.time=Date.now(),E("bottom")&&0!==a.steps){if(x(),p(),s(),o(),l())return a.gameOver=!0,L(),g(),void console.log("game over");t()}else A();a.steps++}J()},r())};window.game=J;var K=function(){h(),I.initializeCanvas(),i(),k(),t(),J()};K();var L=function(){R(a.score)?console.log("new high score"):S(a.score)&&console.log("new top five score")},M=5,N=function(){return JSON.parse(localStorage.highScores||"[]")},O=function(a){var b=N();b.push(a),b.sortNumbers().reverse(),b=b.slice(0,M),localStorage.highScores=JSON.stringify(b)},P=function(a){return a>(N()[0]||0)},Q=function(a){var b=N();return a>(b.last()||0)||b.length<M},R=function(a){return P(a)&&0!=a?(O(a),!0):void 0},S=function(a){return Q(a)&&0!=a?(O(a),!0):void 0};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0},Array.prototype.sortNumbers=function(a){return this.sort(function(a,b){return a-b})}};