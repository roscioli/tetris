window.onload=function(){var a={},b=function(a,b){this.y=a,this.x=b},c=function(a){a?(this.x=a.x,this.y=a.y,this.color=a.color,this.coordinates=a.coordinates,this.next=a.next):(this.x=0,this.y=0,this.color="",this.coordinates=[],this.next=null)},d=[{coordinates:[new b(0,0),new b(0,1),new b(1,0),new b(1,1)],color:"#4F3"},{coordinates:[new b(1,0),new b(1,1),new b(1,2),new b(0,2)],color:"#8CC"},{coordinates:[new b(0,0),new b(0,1),new b(1,1),new b(1,2)],color:"#161"},{coordinates:[new b(0,0),new b(1,0),new b(1,1),new b(1,2)],color:"#309"},{coordinates:[new b(1,0),new b(1,1),new b(0,1),new b(0,2)],color:"#F4A"},{coordinates:[new b(0,0),new b(0,1),new b(0,2),new b(0,3)],color:"#5A2"},{coordinates:[new b(0,0),new b(0,1),new b(0,2),new b(1,1)],color:"#39B"}],e="*",f=function(){window.DataDump={boardWidth:a.boardWidth,boardHeight:a.boardHeight,time:a.time,timeout:q(),timeoutIncrement:a.timeoutIncrement,steps:a.steps,paused:a.paused,gameOver:a.gameOver,score:a.score,lines:a.lines,level:a.level,numberOfLinesBeforeNextLevel:a.numberOfLinesBeforeNextLevel,matrix:a.matrix}},g=function(){a={boardWidth:10,boardHeight:15,time:Date.now(),timeout:1e3,timeoutIncrement:50,steps:0,paused:!1,gameOver:!1,score:0,lines:0,level:1,numberOfLinesBeforeNextLevel:10,matrix:[],piece:new c}};g();var h=function(){a.matrix=[];for(var b=0;b<a.boardHeight;b++)a.matrix.push(i())},i=function(b){for(var c=[],d=b?b:0,e=0;e<a.boardWidth;e++)c.push(d);return c},j=function(){document.onkeydown=function(b){if(b=b||window.event,a.paused)return void H(!1);switch(b.keyCode){case 37:A();break;case 38:y();break;case 39:B();break;case 40:z();break;case 32:C();break;default:H(!0)}}},k=function(){return a.matrix[0].some(G)},l=function(a){return!a.contains(0)},m=function(){return a.matrix.reduce(function(a,b){return a+(l(b)?1:0)},0)},n=function(){for(var b=[],c=[],d=a.matrix.length-1;d>=0;d--){var e=a.matrix[d];l(e)?b.push(i()):c.unshift(e)}a.matrix=b.concat(c),J.renderMatrix()},o=function(){var b=[0,40,100,300,1200],c=m();a.score+=b[c]*p(),a.lines+=c,console.log("score: "+a.score)},p=function(){return Math.floor(a.lines/a.numberOfLinesBeforeNextLevel)+1},q=function(){return Math.max(a.timeout-(a.level-1)*a.timeoutIncrement,a.timeoutIncrement)},r=function(){var b=p();b>a.level&&(a.level=b,console.log("  level: "+a.level),console.log("timeout: "+q()))},s=function(){a.piece=new c(a.piece.next),a.piece.next||(a.piece.next=new c);var b=Math.floor(Math.random()*d.length);a.piece.next.coordinates=d[b].coordinates,a.piece.next.color=d[b].color;var e=E(a.piece.next.coordinates,"x"),f=E(a.piece.next.coordinates,"y");a.piece.next.y=0-f,a.piece.next.x=Math.floor((a.boardWidth-e)/2),w(),console.log("Next piece: "),console.log(a.piece.next)},t=function(){s(),s()},u=function(b){if("clear"===b){var c=0;J.clearPiece()}else{var c=e;J.drawPiece()}for(var c="clear"===b?0:e,d=0;d<a.piece.coordinates.length;d++){var f=a.piece.coordinates[d];a.piece.y+f.y<0||(a.matrix[a.piece.y+f.y][a.piece.x+f.x]=c)}},v=function(){u("clear")},w=function(){u("draw")},x=function(){a.piece.coordinates.forEach(function(b){a.piece.y+b.y<0||(a.matrix[b.y+a.piece.y][b.x+a.piece.x]=a.piece.color)})},y=function(){var c={coordinates:a.piece.coordinates.map(function(a){return new b(0-a.x,a.y)}),x:a.piece.x},d=E(a.piece.coordinates,"x");c.coordinates=c.coordinates.map(function(a){return new b(a.y+d,a.x)});for(var e=E(c.coordinates,"x");c.x+e>=a.boardWidth;)c.x--;var f=c.coordinates.every(function(b){return!F(b.y+a.piece.y,b.x+c.x)});f&&(v(),a.piece.x=c.x,a.piece.coordinates=c.coordinates,w())},z=function(){D("bottom")||(v(),a.piece.y++,w())},A=function(){D("left")||(v(),a.piece.x--,w())},B=function(){D("right")||(v(),a.piece.x++,w())},C=function(){for(;!D("bottom");)v(),a.piece.y++,w()},D=function(c){if("right"===c)var d=function(a){return new b(a.y,a.x+1)};else"left"===c?d=function(a){return new b(a.y,a.x-1)}:"bottom"===c&&(d=function(a){return new b(a.y+1,a.x)});var e=a.piece.coordinates.map(d);return e.some(function(b){var c=b.x+a.piece.x,d=b.y+a.piece.y;return F(d,c)})},E=function(a,b){return a.reduce(function(a,c){return Math.max(a,c[b])},0)},F=function(b,c){return 0>c||c>=a.boardWidth||b>=a.boardHeight||b>=0&&G(a.matrix[b][c])},G=function(a){return a!==e&&0!==a},H=function(b){a.paused=b},I=function(){var b=30,c=document.getElementById("tetris");c.width=b*a.boardWidth,c.height=b*a.boardHeight,window.context=c.getContext("2d");var d="#000",e=function(){return a.piece.color},f=function(b,c){var e=a.matrix[b][c];return G(e)?e:d};this.initializeCanvas=function(){window.context.fillStyle=d,window.context.fillRect(0,0,c.width,c.height)},this.drawPiece=function(c){"clear"===c?window.context.fillStyle=d:window.context.fillStyle=e(),a.piece.coordinates.forEach(function(c){var d=(a.piece.x+c.x)*b,e=(a.piece.y+c.y)*b;window.context.fillRect(d,e,b,b)})},this.clearPiece=function(){this.drawPiece("clear")},this.renderMatrix=function(){for(var c=0;c<a.boardHeight;c++)for(var d=0;d<a.boardWidth;d++)window.context.fillStyle=f(c,d),window.context.fillRect(d*b,c*b,b,b)}},J=new I,K=function(){window.setTimeout(function(){if(!a.paused){if(a.gameOver)return;if(a.time=Date.now(),D("bottom")&&0!==a.steps){if(x(),o(),r(),n(),k())return a.gameOver=!0,M(),f(),void console.log("game over");s()}else z();a.steps++}K()},q())},L=function(){g(),J.initializeCanvas(),h(),j(),t(),K()};L();var M=function(){S(a.score)?console.log("new high score"):T(a.score)&&console.log("new top five score")},N=5,O=function(){return JSON.parse(localStorage.highScores||"[]")},P=function(a){var b=O();b.push(a),b.sortNumbers().reverse(),b=b.slice(0,N),localStorage.highScores=JSON.stringify(b)},Q=function(a){return a>(O()[0]||0)},R=function(a){var b=O();return a>(b.last()||0)||b.length<N},S=function(a){return Q(a)&&0!=a?(P(a),!0):void 0},T=function(a){return R(a)&&0!=a?(P(a),!0):void 0};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0},Array.prototype.sortNumbers=function(a){return this.sort(function(a,b){return a-b})}};