window.onload=function(){var a={},b=function(a,b){this.y=a,this.x=b},c=function(a){a?(this.x=a.x,this.y=a.y,this.color=a.color,this.coordinates=a.coordinates,this.next=a.next,this.locked=a.locked):(this.x=0,this.y=0,this.color="",this.coordinates=[],this.next=null,this.locked=!1)},d=[{coordinates:[new b(0,0),new b(0,1),new b(1,0),new b(1,1)],color:"#4F3"},{coordinates:[new b(1,0),new b(1,1),new b(1,2),new b(0,2)],color:"#8CC"},{coordinates:[new b(0,0),new b(0,1),new b(1,1),new b(1,2)],color:"#161"},{coordinates:[new b(0,0),new b(1,0),new b(1,1),new b(1,2)],color:"#309"},{coordinates:[new b(1,0),new b(1,1),new b(0,1),new b(0,2)],color:"#F4A"},{coordinates:[new b(0,0),new b(0,1),new b(0,2),new b(0,3)],color:"#5A2"},{coordinates:[new b(0,0),new b(0,1),new b(0,2),new b(1,1)],color:"#39B"}],e="*",f={down:{axis:"y",addition:1},right:{axis:"x",addition:1},left:{axis:"x",addition:-1}},g=function(){a={boardWidth:10,boardHeight:16,time:Date.now(),timeout:1e3,levelSpeedup:50,steps:0,paused:!1,gameOver:!1,score:0,lines:0,level:1,linesPerLevel:4,matrix:[],piece:new c,timeForNextGame:!1,message:[]}};g();var h=function(){a.matrix=[];for(var b=0;b<a.boardHeight;b++)a.matrix.push(i())},i=function(b){for(var c=[],d=b?b:0,e=0;e<a.boardWidth;e++)c.push(d);return c},j={handlers:[{keyCode:32,gesture:"press",preventDefault:!0,action:function(){E()},element:document.getElementById("tetris")},{keyCode:37,gesture:"panleft",preventDefault:!0,action:function(){D(f.left)},element:document.getElementById("tetris")},{keyCode:38,gesture:"tap",preventDefault:!0,action:function(){return a.gameOver&&a.timeForNextGame?(S(),void W()):void C()},element:document.getElementById("tetris")},{keyCode:39,gesture:"panright",preventDefault:!0,action:function(){D(f.right)},element:document.getElementById("tetris")},{keyCode:40,gesture:"pandown",preventDefault:!0,action:function(){D(f.down)},element:document.getElementById("tetris")}],"default":{keyCode:"default",gesture:"pinch",action:function(){M()},element:document.body}},k=function(a,b){var c=j.handlers.filter(function(b){return b.keyCode===a.keyCode})[0];console.log(JSON.stringify(c)),c?(c.preventDefault&&a.preventDefault(),c.action()):j["default"].action()},l=function(){document.onkeydown=function(b){return b=b||window.event,a.paused?void L(!1):a.gameOver&&a.timeForNextGame?(S(),void W()):void k(b)},j.handlers.forEach(function(a){m(a)}),m(j["default"])},m=function(a){var b=90;new Hammer(a.element).on(a.gesture,function(c){var d=Date.now();(a.timeLastExecuted&&d-a.timeLastExecuted>b||!a.timeLastExecuted)&&(a.timeLastExecuted=d,a.action())})},n=function(){return a.matrix[0].some(K)},o=function(a){return!a.contains(0)},p=function(){return a.matrix.reduce(function(a,b){return a+(o(b)?1:0)},0)},q=function(){for(var b=[],c=[],d=a.matrix.length-1;d>=0;d--){var e=a.matrix[d];o(e)?b.push(i()):c.unshift(e)}a.matrix=b.concat(c),O.renderMatrix()},r=function(){document.getElementById("score").innerHTML="zen: "+a.score},s=function(){var b=[0,40,100,300,1200],c=p();a.score+=b[c]*t(),a.lines+=c},t=function(){return Math.floor(a.lines/a.linesPerLevel)+1},u=function(){return Math.max(a.timeout-(a.level-1)*a.levelSpeedup,a.levelSpeedup)},v=function(){var b=t();b>a.level&&(a.level=b,console.log("  level: "+a.level),console.log("timeout: "+u()))},w=function(){a.piece=new c(a.piece.next),a.piece.next||(a.piece.next=new c);var b=Math.floor(Math.random()*d.length);a.piece.next.coordinates=d[b].coordinates,a.piece.next.color=d[b].color,P.renderNextPiece(a.piece.next);var e=H(a.piece.next.coordinates),f=I(a.piece.next.coordinates);a.piece.next.y=0-f,a.piece.next.x=Math.floor((a.boardWidth-e)/2),A()},x=function(){w(),w()},y=function(b){if(b)var c=e;else var c=0;O.renderPiece(a.piece,!!b);for(var c=b?e:0,d=0;d<a.piece.coordinates.length;d++){var f=a.piece.coordinates[d];a.piece.y+f.y<0||(a.matrix[a.piece.y+f.y][a.piece.x+f.x]=c)}},z=function(){y(!1)},A=function(){y(!0)},B=function(){a.piece.coordinates.forEach(function(b){a.piece.y+b.y<0||(a.matrix[b.y+a.piece.y][b.x+a.piece.x]=a.piece.color)})},C=function(){if(!a.piece.locked&&!a.paused){var c=I(a.piece.coordinates),d=H(a.piece.coordinates),e=(Math.max(d,c),{coordinates:a.piece.coordinates.map(function(a){return new b(0-a.x,a.y)}),x:a.piece.x});for(e.coordinates=e.coordinates.map(function(a){return new b(a.y+d,a.x)});e.x+c>=a.boardWidth;)e.x--;var f=e.coordinates.every(function(b){return!J(b.y+a.piece.y,b.x+e.x)});f&&(z(),a.piece.x=e.x,a.piece.coordinates=e.coordinates,A())}},D=function(b){a.piece.locked||a.paused||F(b)||(z(),a.piece[b.axis]+=b.addition,A())},E=function(){if(!a.paused){for(;!F(f.down);)z(),a.piece.y++,A();a.piece.locked=!0}},F=function(b){return a.piece.coordinates.some(function(c){var d=c.x+a.piece.x+("x"===b.axis?b.addition:0),e=c.y+a.piece.y+("y"===b.axis?b.addition:0);return J(e,d)})},G=function(a,b){return a.reduce(function(a,c){return Math.max(a,c[b])},0)},H=function(a){return G(a,"x")},I=function(a){return G(a,"y")},J=function(b,c){return 0>c||c>=a.boardWidth||b>=a.boardHeight||b>=0&&K(a.matrix[b][c])},K=function(a){return a!==e&&0!==a},L=function(b){a.paused=b},M=function(){a.paused=!a.paused,console.log("in toggle and paused is: "+a.paused)},N=function(b){b||(b={});var c=28,d=document.getElementById(b.htmlId||"tetris");d.width=c*a.boardWidth,d.height=c*a.boardHeight;var e=d.getContext("2d"),f=b.backgroundColor||"#000",g=this,h=function(b,c){var d=a.matrix[b][c];return K(d)?d:f};this.initializeCanvas=function(){e.fillStyle=f,e.fillRect(0,0,d.width,d.height)},this.renderNextPiece=function(){d.width=(H(a.piece.next.coordinates)+1)*c,d.height=(I(a.piece.next.coordinates)+1)*c,g.initializeCanvas(),g.renderPiece(a.piece.next,!0)},this.hide=function(){d.width=0,d.height=0},this.renderPiece=function(a,b){b?e.fillStyle=a.color:e.fillStyle=f,a.coordinates.forEach(function(b){var d=(a.x+b.x)*c,f=(a.y+b.y)*c;e.fillRect(d,f,c,c)})},this.renderMatrix=function(){for(var b=0;b<a.boardHeight;b++)for(var d=0;d<a.boardWidth;d++)e.fillStyle=h(b,d),e.fillRect(d*c,b*c,c,c)}},O=new N,P=new N({htmlId:"next",backgroundColor:"#FFF"}),Q=function(){r(),window.setTimeout(function(){if(!a.paused){if(a.gameOver)return;if(a.time=Date.now(),F(f.down)&&0!==a.steps){if(B(),s(),v(),q(),n())return a.gameOver=!0,a.timeForNextGame=!1,void T();w()}else D(f.down);a.steps++}Q()},u())},R=function(){g(),O.initializeCanvas(),h(),l()},S=function(){R(),x(),Q()};R(),S(),window.Game=a;var T=function(){V("Game over."),aa(a.score)?V("Highest zen achieved."):ba(a.score)&&V("Nice zen."),P.hide(),window.setTimeout(U,1e3)},U=function(){a.timeForNextGame=!0;var b="Press any key to start a new game.";V(b)},V=function(b){a.message.push(b),document.getElementById("message").innerHTML=a.message.join("<br/><br/>")},W=function(){document.getElementById("message").innerHTML=""},X=5,Y=function(){return JSON.parse(localStorage.highScores||"[]")},Z=function(a){var b=Y();b.push(a),b.sortNumbers().reverse(),b=b.slice(0,X),localStorage.highScores=JSON.stringify(b)},$=function(a){return a>(Y()[0]||0)},_=function(a){var b=Y();return a<b[0]||a>(b.last()||0)||b.length<X},aa=function(a){return $(a)&&0!=a?(Z(a),!0):void 0},ba=function(a){return _(a)&&0!=a?(Z(a),!0):void 0};Array.prototype.last=function(){return this[this.length-1]},Array.prototype.contains=function(a){return this.indexOf(a)>=0},Array.prototype.sortNumbers=function(a){return this.sort(function(a,b){return a-b})}};